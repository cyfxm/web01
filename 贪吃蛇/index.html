<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <input type="text" class="score" value="0" disabled="disabled">
    <script>
        var score = document.querySelector(".score");
        // 定义一个保存分数的全局变量
        var fenshu = 0;
        var speed = 200;
        
        // 创建地图
        function Map(){
            this.width = "900px";
            this.height = "600px";
            this.backgroundColor = "#cccccc";
            this.position = "relative";
            // 定义一个属性,专门保存dom节点
            this._map = null;
        }

        Map.prototype.show = function(){
            this._map = document.createElement("div");
            this._map.style.width = this.width;
            this._map.style.height = this.height ;
            this._map.style.backgroundColor = this.backgroundColor;
            this._map.style.position = this.position;
            document.body.appendChild(this._map);
        }

        // 封装实物类
        function Food(){
            this.width = "20px";
            this.height = "20px";
            this.backgroundColor = "red";
            this.position = "absolute";
            // 食物出现在地图的某个位置
            this.x = 0;
            this.y = 0;
            // 定义一个保存食物节点
            this._food = null;
        }

        // 食物的方法
        Food.prototype.show = function(){
            if(this._food == null ){
                this._food = document.createElement("div");
                this._food.style.width = this.width;
                this._food.style.height = this.height ;
                this._food.style.backgroundColor = this.backgroundColor;
                this._food.style.position = this.position;
                map._map.appendChild(this._food);
            }

            this.randomPos();
            // 食物出现在地图的某个位置
            this._food.style.left = this.x * 20 + "px";
            this._food.style.top = this.y * 20 + "px";
        }

        // 实现食物随机
        Food.prototype.randomPos = function(){
            // 水平取值范围
            this.x = Math.floor(Math.random() *40);
            // 垂直取值范围
            this.y = Math.floor(Math.random() *30);
        }

        // 定义蛇类
        function Snake(){
            // 蛇身数据
            this.body = [
                [2,1,"yellow",null],
                [1,1,"green",null],
                [1,0,"green",null],
                [0,0,"green",null]
            ]
            this.width = "20px";
            this.height = "20px";
            this.position = "absolute";
            // this.
            // 默认右方向移动
            this.direct = "right";
        }

        // 蛇类显示方法
        Snake.prototype.show = function(){
            this.body.forEach(function(item){
                if(item[3] == null){
                    item[3] = document.createElement("div");
                    map._map.appendChild(item[3]);
                }
                // item就是每个蛇节的数据
                item[3].style.width = snake.width;
                item[3].style.height = snake.height;
                item[3].style.position = snake.position;
                item[3].style.backgroundColor = item[2];

                item[3].style.left = item[0]*20 + "px";
                item[3].style.top = item[1]*20 + "px";
            });
        }

        // 封装蛇运动
        Snake.prototype.move = function(){
            // 倒叙遍历蛇身数据
            for(var i = this.body.length -1; i > 0;i--){
                // 设置x坐标
                this.body[i][0] = this.body[i-1][0]
                // 设置y坐标
                this.body[i][1] = this.body[i-1][1]
            }
            switch( this.direct ){
                case "up":
                    this.body[0][1]--;
                    break;
                case "down":
                    this.body[0][1]++;
                    break;
                case "left":
                    this.body[0][0]--;
                    break;
                case "right":
                    this.body[0][0]++;
                    break;
            }
            // 重新渲染蛇
            this.show();
        }

        document.onkeydown = function(e){
            e = e || window.event;
            switch( e.key ){
                case "w":
                    if(snake.direct!= "down"){
                        snake.direct = "up";
                    }
                    break;

                case "s":
                    if(snake.direct!= "up"){
                            snake.direct = "down";
                        }
                    break;

                case "a":
                    if(snake.direct!= "right"){
                        snake.direct = "left";
                    }
                    break;

                case "d":
                    if(snake.direct!= "left"){
                            snake.direct = "right";
                        }
                    break;
            }
        }

        // 检测是否能吃到食物
        Snake.prototype.eat = function(){
            if(this.body[0][0] == food.x && this.body[0][1] == food.y){
                food.show();
                this.body.push( [-1,-1,"green",null] );
                score.value = ++fenshu; 
                if( fenshu % 1 == 0){
                    // 让速度加快
                    speed --;
                    console.log(speed);
                }
            }
        }

        // 判断蛇是否出界
        Snake.prototype.border = function(){
            if(this.body[0][0] < 0 || this.body[0][0] > 39 || this.body[0][1] < 0 || this.body[0][1] > 29){
                alert("游戏结束");
                window.clearInterval(timer);
            }
        }

        // 判断是否自己吃自己
        Snake.prototype.suicide = function(){
            for( var i = 4; i < this.body.length; i++ ){
                if( this.body[i][0] == this.body[0][0] && this.body[i][1] ==  this.body[0][1] ){
                    alert("游戏结束");
                    window.clearInterval(timer);
                }
            }
        }

        var map = new Map();
        map.show();

        var food = new Food();
        food.show();

        var snake = new Snake();
        snake.show();
        
        var timer = setInterval(function(){
            snake.move();
            // 判断是否吃到食物
            snake.eat();
            snake.border();
            snake.suicide();
        },speed)
    </script>
</body>
</html>