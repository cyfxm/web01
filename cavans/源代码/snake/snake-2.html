<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
</head>

<body>

    <canvas id="canvas"></canvas>

    <script>
        // 1.0 获取元素
        var canvas = document.getElementById("canvas");
        canvas.width = 600;
        canvas.height = 600;
        var ctx = canvas.getContext("2d");

        // 2.0 构造函数
        function Snake(options) {
            this.width = options.width;
            this.height = options.height;
            this.space = options.space;//每一格子的宽高
            this.column = options.width / this.space;
            this.row = options.height / this.space;
            this.direction = "down";
            this.timer = null;
            this.ctx = options.ctx;
        }
        // 3.0 初始化
        Snake.prototype.init = function () {
            var _this = this;
            // 绘制地图
            this.drawMap();
            // 绘制蛇
            this.drawInitSnake();
            // 绘制食物
            this.drawFood();
            // 事件监听
            this.addEvent();
            // 让蛇动起来
            this.timer = setInterval(function () {
                _this.drawSnake(); //

            }, 150)
        }

        // 4.初始化 蛇
        Snake.prototype.drawInitSnake = function () {
            this.snake = [
                { x: 0, y: 20, color: "blue" },
                { x: 20, y: 20, color: "blue" },
                { x: 40, y: 20, color: "red" }
            ]

            for (var i = 0; i < this.snake.length; i++) {
                this.ctx.beginPath();
                this.ctx.rect(
                    this.snake[i].x,
                    this.snake[i].y,
                    this.space,
                    this.space
                )
                this.ctx.fillStyle = this.snake[i].color;
                this.ctx.fill();
            }
        }
        // 5.0 绘制地图
        Snake.prototype.drawMap = function () {
            this.ctx.strokeStyle = "#333";
            for (var i = 0; i <= this.column; i++) {

                this.ctx.moveTo(0, i * this.space);
                this.ctx.lineTo(this.width, i * this.space);

                this.ctx.moveTo(i * this.space, 0);
                this.ctx.lineTo(i * this.space, this.height);

                this.ctx.stroke();
            }
        }
        // 6.0 绘制食物
        Snake.prototype.drawFood = function () {
            this.food = {
                x: 80,
                y: 40,
                color: "orange"
            }
            this.ctx.beginPath();
            this.ctx.rect(this.food.x, this.food.y, this.space, this.space)
            this.ctx.fillStyle = this.food.color;
            this.ctx.fill();
        }
        // 7.0 创建食物
        Snake.prototype.createFood = function () {
            this.food = {
                x: Math.floor(Math.random() * this.column) * this.space,
                y: Math.floor(Math.random() * this.row) * this.space,
                color: "orange"
            }

            this.ctx.beginPath();
            this.ctx.rect(
                this.food.x, this.food.y, this.space, this.space
            )
            this.ctx.fillStyle = this.food.color;
            this.ctx.fill();
        }
        // 8.0 添加事件
        Snake.prototype.addEvent = function () {
            var _this = this;
            document.addEventListener('keydown', function (evt) {
                var event = evt || window.event;
                var keyCode = event.keyCode;
                // this 谁调用函数（事件） this 指向谁 doument
                if (keyCode == 38 && _this.direction != 'down') {
                    _this.direction = 'up'
                }
                if (keyCode == 40 && _this.direction != 'up') {

                    _this.direction = 'down'
                }
                if (keyCode == 37 && _this.direction != 'right') {

                    _this.direction = 'left'
                }
                if (keyCode == 39 && _this.direction != 'left') {

                    _this.direction = 'right'
                }
            })
        }
        // 9.0 蛇移动函数
        Snake.prototype.snakeMove = function () {
            this.x = 0;
            this.y = 0;
            if (this.direction == "right") {
                this.x = this.space;
            }
            if (this.direction == "left") {
                this.x = -this.space;
            }
            if (this.direction == "down") {
                this.y = this.space;
            }
            if (this.direction == "up") {
                this.y = -this.space;
            }
            console.log(this.x,this.y)
            // 更新蛇的坐标
            for (var i = 0; i < this.snake.length - 1; i++) {
                this.snake[i].x = this.snake[i + 1].x;
                this.snake[i].y = this.snake[i + 1].y;
            }
            // 设置蛇头
            this.snake[this.snake.length - 1].x += this.x;
            this.snake[this.snake.length - 1].y += this.y;
        }
        // 10.0 判断蛇和食物碰撞
        Snake.prototype.eatFood = function () {
            //检测蛇头和食物的碰撞
            if (this.snake[this.snake.length - 1].x == this.food.x && this.snake[this.snake.length - 1].y == this.food.y) {   
                // 吃到食物添加蛇身体
                this.addSnake();
                // 蛇吃到食物的时候 再次创建
                this.createFood();
            }

        }
        // 11.0 绘制蛇
        Snake.prototype.drawSnake = function () {
            this.ctx.clearRect(
                this.snake[0].x,
                this.snake[0].y,
                this.space,
                this.space
            )
            // 需要重新绘制地图
            this.drawMap();
            // 需要移动蛇
            this.snakeMove();
            // 需要更新蛇的位置
            for (var i = 0; i < this.snake.length; i++) {
                this.ctx.beginPath();
                this.ctx.rect(this.snake[i].x, this.snake[i].y, this.space, this.space);
                this.ctx.fillStyle = this.snake[i].color;
                this.ctx.fill();
            }
            //检测蛇头和食物碰撞
			this.eatFood();
            //记录蛇的身体的坐标
			this.copySnake();
        }
        // 12. 添加蛇身体
        Snake.prototype.addSnake = function () { 
            var new_body = {
                x:this.snake[0].x - this.space,
                y:this.snake[0].y - this.space,
                color:"blue"
            }
            //蛇吃到食物需要往尾巴添加一个（格子）坐标
			this.snake.unshift(new_body);
        }
        // 13. 判断是否结束游戏
        Snake.prototype.isGameOver = function (newSnake) {
            //记录蛇头
            var snakeHead = this.snake[this.snake.length-1];
            
            if(snakeHead.x  < 0 || snakeHead.x > this.width || snakeHead.y < 0 || snakeHead.y>this.height){
                console.log("跑出地球了")
                clearInterval(this.timer)
            }
            //主要检测蛇头部和身体碰撞
            for(var i = 0 ; i < newSnake.length;i++){
                for(var j = i+1 ; j < newSnake.length;j++ ){
                    if(newSnake[j].x == newSnake[i].x &&newSnake[j].y == newSnake[i].y){
                        clearInterval(this.timer);
                        console.log("自己碰自己了");
						return ; 
                    }
                }
            }
         }
        //  14.0 复制一份数据，便于检测蛇头和身碰撞
        Snake.prototype.copySnake = function () { 
            this.newSnake = [];
            for(var i = 0 ; i < this.snake.length ; i ++){
                this.newSnake.push({
                    x:this.snake[i].x,
                    y:this.snake[i].y
                })
            }
            this.isGameOver(this.newSnake);
        }
        // 15.0 实例化对象 调用init函数
        new Snake({
            width: canvas.width,
            height: canvas.height,
            space: 20,
            ctx: ctx
        }).init()

    </script>
</body>

</html>